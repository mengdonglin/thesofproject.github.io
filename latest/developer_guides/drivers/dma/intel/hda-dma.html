

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cAVS HD/A DMA Driver &mdash; SOF Project 0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/sof-favicon-16x16.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sof-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="DAI Drivers" href="../../dai/index.html" />
    <link rel="prev" title="Intel Platforms" href="index.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> SOF Project
          

          
            
            <img src="../../../../_static/logo_sof_white_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/index.html">Introduction to the SOF Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../introduction/index.html#components">Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../introduction/index.html#sof-architecture">SOF Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../introduction/index.html#sof-driver-architecture">SOF Driver Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../introduction/index.html#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../getting_started/index.html#building-sof">Building SOF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/build-guide/build-from-scratch.html">Build SOF from scratch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/build-guide/build-from-scratch.html#build-sof-binaries">Build SOF binaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/build-guide/build-from-scratch.html#build-linux-kernel">Build Linux kernel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/build-guide/build-with-docker.html">Build SOF with Docker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/build-guide/build-with-docker.html#set-up-docker">Set up Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/build-guide/build-with-docker.html#id1">Build with Docker</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../getting_started/index.html#setting-up-sof-on-hardware">Setting up SOF on hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/setup/setup_minnowboard_turbot.html">Set up SOF on MinnowBoard Turbot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_minnowboard_turbot.html#minnowboard-resources">MinnowBoard resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_minnowboard_turbot.html#development">Development</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/setup/setup_up_2_board.html">Set up SOF on Up Squared board with Hifiberry DAC+ (STD)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_up_2_board.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_up_2_board.html#setup-instructions">Setup Instructions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/setup/setup_ktest_environment.html">Set up a Ktest-based environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_ktest_environment.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_ktest_environment.html#prerequisites-on-the-target-device">Prerequisites on the target device</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_ktest_environment.html#configure-ssh-without-password">Configure SSH without password</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/setup/setup_ktest_environment.html#create-a-linux-development-environment">Create a linux development environment</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../getting_started/index.html#other-guides">Other guides</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../getting_started/cavs-boot/index.html">Booting up CAVS ADSP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/cavs-boot/cavs-dsp-boot-overview.html">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../getting_started/cavs-boot/apollolake/index.html">Apollolake Boot Process</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../platforms/index.html">Supported Platforms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../platforms/intel-cavs/index.html">Intel CAVS Platforms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../platforms/intel-cavs/commons/index.html">CAVS Commons</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../platforms/intel-cavs/commons/work-queue.html">Work Queues</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../platforms/intel-cavs/apollolake/index.html">Intel Apollo Lake</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../platforms/intel-cavs/apollolake/apl-memory.html">APL Memory</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../platforms/intel-cavs/cannonlake/index.html">Intel Cannon Lake</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../platforms/intel-cavs/cannonlake/cnl-memory.html">CNL Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../platforms/intel-cavs/cannonlake/cnl-config.html">CNL Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../platforms/intel-cavs/icelake/index.html">Intel Ice Lake</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../porting.html">Porting Guides</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../porting.html#architecture-porting-guide">Architecture Porting Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../porting.html#platform-porting-guide">Platform Porting Guide</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Drivers</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">DMA Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#intro">Intro</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#programming-flows">Programming Flows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#using-dma-driver-api">Using DMA Driver API</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#supported-devices">Supported Devices</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dai/index.html">DAI Drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dai/index.html#intro">Intro</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dai/index.html#programming-flows">Programming Flows</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dai/index.html#using-dai-driver-api">Using DAI Driver API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dai/index.html#supported-devices">Supported Devices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../kernel/index.html">Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../kernel/mem-mgmt.html">Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/mem-mgmt.html#heap-memory-zones">Heap Memory Zones</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/mem-mgmt.html#system-zone">System Zone</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/mem-mgmt.html#runtime-zone">Runtime Zone</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/mem-mgmt.html#buffer-zone">Buffer Zone</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../kernel/work-queue.html">Work Queue</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/work-queue.html#basic-work-queue-flow">Basic Work Queue Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../kernel/work-queue.html#extensions-for-smp-architectures">Extensions for SMP Architectures</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apps/index.html">Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apps/components/index.html">Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/components/new-comp-guide.html">Writing a New Component</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/components/component-api.html">Component API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/components/component-mgmt-api.html">Managing the Components</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../apps/pipelines/index.html">Pipelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#creating-a-pipeline">Creating a Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#executing-an-operation">Executing an Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#resetting-pipeline">Resetting Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#configuring-audio-parameters-preparing-for-use">Configuring Audio Parameters &amp; Preparing for Use</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#scheduling">Scheduling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apps/pipelines/index.html#processing">Processing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../unit_tests.html">Unit Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../unit_tests.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../unit_tests.html#enabling-unit-tests">Enabling unit tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../unit_tests.html#example-running-tests-for-apl">Example: Running tests for APL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../unit_tests.html#preparing-cmocka-package">Preparing cmocka package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../unit_tests.html#wrapping-objects-for-unit-tests">Wrapping objects for unit tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../unit_tests.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../topology/topology.html">SOF Topology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../topology/topology.html#topology-ingredients">1. Topology Ingredients</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#widgets">1.1 Widgets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#tokens-vendor-tuples">1.2 Tokens/Vendor Tuples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#kcontrols">1.3 Kcontrols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#pipelines">1.4 Pipelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#backend-dai">1.5 Backend DAI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#backend-dai-link-config">1.6 Backend DAI link Config</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../topology/topology.html#how-to-create-a-new-topology">2. How to create a new topology?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#example-topology-with-single-pipeline">2.1 Example topology with single pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../topology/topology.html#example-topology-with-multiple-pipelines">2.2 Example topology with multiple pipelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../topology/topology.html#acronyms">3. Acronyms</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../howtos/index.html">How-Tos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../howtos/index.html#technical-notes">Technical Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../howtos/tech/compile_wsl.html">Build on Windows 10 with WSL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/tech/compile_wsl.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/tech/compile_wsl.html#enable-32-bit-binaries">Enable 32-bit binaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/tech/compile_wsl.html#fix-stat-in-32-bit-binaries">Fix stat in 32-bit binaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/tech/compile_wsl.html#compile">Compile</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../howtos/index.html#process-notes">Process Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../howtos/process/docbuild.html">SOF documentation generation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../howtos/process/docbuild.html#publishing-content">Publishing content</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute/index.html">Contributing to the Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../contribute/contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../contribute/contribute_guidelines.html#dco-sign-off-methods">DCO Sign-Off Methods</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/contribute_guidelines.html#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contribute/doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contribute/dox-source-code.html">Documenting the Source Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/dox-source-code.html#basic-rules">Basic Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../contribute/dox-source-code.html#examples">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/dma-drivers-api.html">DMA Drivers API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/dai-drivers-api.html">DAI Drivers API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/platform-api.html">Platform API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/uapi.html">uAPI</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">SOF Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="../../index.html">Drivers</a> &raquo;</li>
        
          <li><a href="../index.html">DMA Drivers</a> &raquo;</li>
        
          <li><a href="index.html">Intel Platforms</a> &raquo;</li>
        
      <li>cAVS HD/A DMA Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cavs-hd-a-dma-driver">
<span id="intel-cavs-hda-dma-driver"></span><h1>cAVS HD/A DMA Driver<a class="headerlink" href="#cavs-hd-a-dma-driver" title="Permalink to this headline">¶</a></h1>
<div class="section" id="probing">
<h2>Probing<a class="headerlink" href="#probing" title="Permalink to this headline">¶</a></h2>
<p>A basic initialization of basic data structures is performed. No piece of
HD/A HW is touched at this point.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>HD/A DMA works with a single continuous circular buffer only. Therefore, the
SGLs are verified if they are of the same size and point to a continuous
memory space.</p>
<p>The total buffer size (period size x number of periods) must be a multiple of
HD/A DMA burst size (32 bytes).</p>
<p>The initial DMA HW buffer setup takes place.</p>
</div>
<div class="section" id="setting-up-callback">
<h2>Setting up Callback<a class="headerlink" href="#setting-up-callback" title="Permalink to this headline">¶</a></h2>
<p>A client (a host/dai component for instance) registers a callback by calling
<code class="docutils literal notranslate"><span class="pre">dma_set_cb()</span></code> which is notified upon completion of the transfer of each period of
data.</p>
<p>The size of the period is specified by SGL elements passed to <code class="docutils literal notranslate"><span class="pre">dma_set_config()</span></code>.</p>
</div>
<div class="section" id="starting-the-device">
<h2>Starting the Device<a class="headerlink" href="#starting-the-device" title="Permalink to this headline">¶</a></h2>
<p>The device is registered in the PM platform driver to ensure that the DMI L1 is
handled properly.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not required when the PM call is made by the device
driver, but when the call is moved to the systick handler, the PM
platform driver must know if any active DMA devices are registered.</p>
</div>
<div class="figure" id="id1">
<p class="plantuml">
<object data="../../../../_images/plantuml-5a77548281d4ac75bc82b313c4154163610bcf69.svg" type="image/svg+xml" style="width:844px;height:898px;">
<img src="../../../../_images/plantuml-5a77548281d4ac75bc82b313c4154163610bcf69.png" alt="box &quot;Host&quot; #ffffff
    participant &quot;Host\nDriver&quot; as drv
end box
box &quot;HD/A HW&quot;
	participant hda_sw
	participant hda_fw
end box
box &quot;DSP&quot; #ffffff
    participant host
    participant hda_dma
end box

note over hda_sw, hda_fw: &quot;DMA in RESET state&quot;

-&gt; drv : Create Stream
    drv -&gt; host : new()
        host -&gt; hda_dma : dma_get(dmac_id)
            host &lt;-- hda_dma : dmac

        drv &lt;-- host
    &lt;-- drv

-&gt; drv : Stream Params
    drv -&gt; hda_sw : setup DMA (format &amp; BDL)

    drv -&gt; host : params()
        host -&gt; hda_dma : dma_channel_get(dmac, params.stream_tag)
            host &lt;-- hda_dma : chan

        host -&gt; hda_dma : dma_set_config(dmac, chan, config)
            hda_fw &lt;- hda_dma : DGBBA, DGBS
            hda_fw &lt;- hda_dma : DGMBS := buffer size [host dma]
            hda_fw &lt;- hda_dma : GEN := 0
            hda_fw &lt;- hda_dma : SCS := 1 [bit_depth != 32]
            hda_fw &lt;- hda_dma : FWCB : = 1
            hda_fw &lt;- hda_dma : FIFORDY := 0
            host &lt;-- hda_dma

        drv &lt;-- host
    &lt;-- drv

-&gt; drv : RUN
    drv -&gt; hda_sw : RUN := 1

    drv -&gt; host : trigger(COMP_TRIGGER_START)
        host -&gt; hda_dma : dma_start()
            hda_fw &lt;- hda_dma : GEN := 1
            hda_fw &lt;- hda_dma : FIFORDY := 1
            host &lt;-- hda_dma
        drv &lt;-- host
    &lt;-- drv
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 15 </span><span class="caption-text">HD/A DMA Device Start Flow</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="stopping-the-device">
<h2>Stopping the Device<a class="headerlink" href="#stopping-the-device" title="Permalink to this headline">¶</a></h2>
<p>HW reset is programmed by setting <code class="docutils literal notranslate"><span class="pre">GEN</span></code> to 0. DSP confirms <code class="docutils literal notranslate"><span class="pre">GBUSY</span></code> is 0;
otherwise, an exception is reported to the host.</p>
<div class="figure" id="id2">
<p class="plantuml">
<object data="../../../../_images/plantuml-3df581bb51ec3c99dbcbaad84967e07a6e3562ea.svg" type="image/svg+xml" style="width:642px;height:446px;">
<img src="../../../../_images/plantuml-3df581bb51ec3c99dbcbaad84967e07a6e3562ea.png" alt="box &quot;Host&quot; #ffffff
    participant &quot;Host\nDriver&quot; as drv
end box
box &quot;HD/A HW&quot;
	participant hda_sw
	participant hda_fw
end box
box &quot;DSP&quot; #ffffff
    participant host
    participant hda_dma
end box

note over hda_sw, hda_fw: &quot;DMA in RUNNING state&quot;

-&gt; drv : Stop?

    drv -&gt; host : COMP_TRIGGER_PAUSE ?
            note right : No more FPI touching at this point
        drv &lt;-- host

    drv -&gt; hda_sw : RUN := 0

    drv -&gt; host : COMP_TRIGGER_STOP
        host -&gt; hda_dma : dma_stop()
            hda_fw &lt;- hda_dma : GEN := 0
            hda_fw &lt;- hda_dma : FIFORDY := 0
            host &lt;-- hda_dma
        drv &lt;-- host

    drv -&gt; hda_sw : Flush DMA,\nset SRST (stream reset)
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 16 </span><span class="caption-text">HD/A DMA Device Stop Flow</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="transferring-data">
<h2>Transferring Data<a class="headerlink" href="#transferring-data" title="Permalink to this headline">¶</a></h2>
<p>Transmission is started on the DSP side after the <code class="docutils literal notranslate"><span class="pre">dma_start()</span></code> is
called as <code class="docutils literal notranslate"><span class="pre">GEN</span></code> is set to 1 there.</p>
<div class="section" id="interrupts">
<h3>Interrupts<a class="headerlink" href="#interrupts" title="Permalink to this headline">¶</a></h3>
<p>Segment completion interrupts are unavailable; therefore, the DSP has to
calculate the amount of space/data available in the buffer manually by reading HD/A
register values.</p>
<p>Any blocking polling must be done for as short a time as possible to release the
CPU for other tasks. The HD/A driver uses the system work queue API to check for IO
completion in the context of timer callbacks deferred to a point in time when
the IO operation is expected to finish.</p>
</div>
<div class="section" id="power-management">
<h3>Power Management<a class="headerlink" href="#power-management" title="Permalink to this headline">¶</a></h3>
<p>The driver prevents the DMI from entering L1 at the end of each data copy
request for a host HD/A DMA to secure the transfer operation.</p>
</div>
<div class="section" id="cyclic-vs-non-cyclic-mode-of-work">
<h3>Cyclic vs. Non-cyclic Mode of Work<a class="headerlink" href="#cyclic-vs-non-cyclic-mode-of-work" title="Permalink to this headline">¶</a></h3>
<p>Four types of HD/A DMAs exist:</p>
<ul class="simple">
<li>Host Output DMA - host memory to DSP memory</li>
<li>Host Input DMA  - DSP memory to host memory</li>
<li>Link Output DMA - DSP memory to peripheral device memory</li>
<li>Link Input DMA - peripheral device memory to DSP memory</li>
</ul>
<p>Host DMAs work in a non-cyclic mode in SOF, i.e. the transfer of a full period is
scheduled on demand each time and completes very quickly.</p>
<p>Link DMAs work in cyclic mode. In the case of HD/A DMA, DMA pointers
are updated in real-time with a small step.</p>
<div class="section" id="host-output-dma-on-demand-mode">
<h4>Host Output DMA (On Demand Mode)<a class="headerlink" href="#host-output-dma-on-demand-mode" title="Permalink to this headline">¶</a></h4>
<p>Host Output DMA provides input data for the DSP on a playback path. In the
beginning, once the DMA is started, the host fills up the entire buffer with data
(the buffer size is typically set to two periods of data). Subsequent transfers
are requested by the DSP by advancing its read pointer, making space for the next
transfer available to the host side. It takes some time for the initial
transfer to complete (buffer full is signaled), so the DSP should not expect
the data to be available “instantly” after the DMA is started. It should not wait
in blocking mode for “buffer full” either. However, the second copy operation
run by the pre-loader task presents a good opportunity to eventually “complete” the first transfer and reliably commit the data for further processing by the
pipeline.</p>
<div class="figure" id="id3">
<p class="plantuml">
<object data="../../../../_images/plantuml-40aa04adf50d97a77a62999df6c35ffa5d2790e1.svg" type="image/svg+xml" style="width:1042px;height:998px;">
<img src="../../../../_images/plantuml-40aa04adf50d97a77a62999df6c35ffa5d2790e1.png" alt="actor drv as &quot;Host\nDriver&quot;
participant ppl as &quot;pipeline&quot;
participant host as &quot;host\ncomponent&quot;
participant hda_dma
participant hda_hw as &quot;HD/A HW&quot;

== Start Trigger ==

drv -&gt; ppl : &lt;&lt;IPC&gt;&gt; trigger (START)
   activate ppl

   ppl -&gt; host : trigger (START)
      activate host

      host -&gt; hda_dma : dma_start()
         activate hda_dma
      host &lt;-- hda_dma
      deactivate hda_dma

      host -&gt; hda_dma : copy(flags = PRELOAD)
         activate hda_dma
         note right: Do not expect Buffer Full yet.
         hda_dma -&gt; hda_dma : state += PRELOAD
         hda_dma -&gt; hda_dma : preload()
            activate hda_dma
            note right : First non-blocking BF test
         deactivate hda_dma
         hda_dma -&gt; hda_dma : state += BF_WAIT
      host &lt;-- hda_dma
      deactivate hda_dma
   ppl &lt;-- host
   deactivate host

   ppl -&gt; ppl : schedule_copy_idle()
      activate ppl
      note right: Scheduler got a ppl task (pre-loader)\n to run in idle
   deactivate ppl
drv &lt;-- ppl
deactivate ppl

== Pre-load ==

-&gt; ppl : pipeline_task
   activate ppl
   ppl -&gt; ppl : pipeline_copy
      activate ppl
      ppl -&gt; host : copy()
         activate host
         host -&gt; hda_dma : copy()
            activate hda_dma
            hda_dma -&gt; hda_dma : preload()
               activate hda_dma
               note right : Blocking BF wait this time
               host &lt;- hda_dma : callback() /for each period/
                  activate host
                  host -&gt; host : comp_update_buffer_produce()
               host --&gt; hda_dma
               deactivate host
               hda_dma -&gt; hda_dma : clear state flags
note right: Switching to normal on demand mode.\n\
Rptr (FPI) advanced on the next copy()\n\
Once the first period is processed.
            deactivate hda_dma
         host &lt;-- hda_dma
         deactivate hda_dma
      ppl &lt;-- host
      deactivate host
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 17 </span><span class="caption-text">Host output startup sequence</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="link-input-output-dma-cyclic-mode">
<h4>Link Input/Output DMA (Cyclic Mode)<a class="headerlink" href="#link-input-output-dma-cyclic-mode" title="Permalink to this headline">¶</a></h4>
<p>In order to enable cyclic mode, with no interrupt available, the DMA driver
schedules work every 1ms.</p>
<div class="figure" id="id4">
<p class="plantuml">
<object data="../../../../_images/plantuml-cba96e2c60dcb47276e5b3b2387356dc4bc13da3.svg" type="image/svg+xml" style="width:784px;height:499px;">
<img src="../../../../_images/plantuml-cba96e2c60dcb47276e5b3b2387356dc4bc13da3.png" alt="actor client as &quot;dai\ncomponent&quot;
participant hda_dma
participant work_queue

client -&gt; hda_dma : dma_start()
	activate hda_dma
	note right: GEN := 1 -&gt; transfer starts

	hda_dma -&gt; work_queue : work_schedule_default(&amp;hda_work, HDA_LINK_1MS_US)
	hda_dma &lt;-- work_queue
client &lt;-- hda_dma
deactivate hda_dma

... 1 ms elapsed ...

work_queue -&gt; hda_dma : hda_work-&gt;cb()
	activate hda_dma

   hda_dma -&gt; hda_dma : update FPI by 'bytes'
   note right: 'commit' is always true in this scenario

	hda_dma -&gt; hda_dma : wait for next period to be available (w/ short t/o)

	hda_dma -&gt; client : callback()
		activate client
		client -&gt; client : comp_update_buffer_produce/consume()
	hda_dma &lt;-- client
	deactivate client

work_queue &lt;-- hda_dma : 1MS_TIMEOUT (to re-arm the timer)
deactivate hda_dma
"/>

</object></p>
<p class="caption"><span class="caption-number">Figure 18 </span><span class="caption-text">Callback notification for link playback and capture</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>Passthrough pipelines (host-dai) with a period size unaligned to HD/A DMA
burst size (32 bytes) cannot work with 2-periods shared buffer configured. If
the DSP moves the read pointer by unaligned size of the period, the tail
(period % burst size) is not transferred until the next pointer move.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SOF Project.
      Last updated on Oct 02, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>